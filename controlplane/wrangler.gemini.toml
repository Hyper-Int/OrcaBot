# Frozen deployment for gemini.orcabot.com (hackathon demo)
# Deploy with: wrangler deploy -c wrangler.gemini.toml
#
# SECRETS (set via wrangler secret):
#   wrangler secret put ACCESS_CODE -c wrangler.gemini.toml
#   wrangler secret put SANDBOX_URL -c wrangler.gemini.toml
#   wrangler secret put SANDBOX_INTERNAL_TOKEN -c wrangler.gemini.toml
#   wrangler secret put INTERNAL_API_TOKEN -c wrangler.gemini.toml
#   wrangler secret put GOOGLE_CLIENT_SECRET -c wrangler.gemini.toml
#   wrangler secret put SECRETS_ENCRYPTION_KEY -c wrangler.gemini.toml
#   wrangler secret put RESEND_API_KEY -c wrangler.gemini.toml

name = "orcabot-controlplane-gemini"
main = "src/index.ts"
compatibility_date = "2024-01-01"

# Custom domain - serves the worker at api.gemini.orcabot.com
routes = [
  { pattern = "api.gemini.orcabot.com", custom_domain = true, zone_name = "orcabot.com" }
]

[vars]
# Deployment environment
ENVIRONMENT = "production"

# Authentication - Dev auth DISABLED, code login via ACCESS_CODE secret
DEV_AUTH_ENABLED = "false"

# CORS - Only allow the gemini frontend
ALLOWED_ORIGINS = "https://gemini.orcabot.com"

# OAuth (client IDs only - secrets go in wrangler secret)
FRONTEND_URL = "https://gemini.orcabot.com"
GOOGLE_CLIENT_ID = "800055652303-t2jus6l3rlkle2fd3a0vrtihs974o6ul.apps.googleusercontent.com"

# Email sender for invitation emails
EMAIL_FROM = "OrcaBot <noreply@orcabot.com>"

# Rate limiting - unauthenticated (strict)
[[unsafe.bindings]]
name = "RATE_LIMITER"
type = "ratelimit"
namespace_id = "1"
simple = { limit = 200, period = 60 }

# Rate limiting - authenticated (generous)
[[unsafe.bindings]]
name = "RATE_LIMITER_AUTH"
type = "ratelimit"
namespace_id = "2"
simple = { limit = 200, period = 60 }

# Durable Objects for real-time collaboration
[[durable_objects.bindings]]
name = "DASHBOARD"
class_name = "DashboardDO"

# Durable Objects for integration policy rate limiting
[[durable_objects.bindings]]
name = "RATE_LIMIT_COUNTER"
class_name = "RateLimitCounter"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["DashboardDO"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["RateLimitCounter"]

# Durable Objects for ASR WebSocket streaming proxy
[[durable_objects.bindings]]
name = "ASR_STREAM"
class_name = "ASRStreamProxy"

[[migrations]]
tag = "v3"
new_sqlite_classes = ["ASRStreamProxy"]

# D1 Database - Shared production database
[[d1_databases]]
binding = "DB"
database_name = "orcabot-db-production"
database_id = "93828ba8-1160-49ec-8d82-6c1bc52800a1"

[[r2_buckets]]
binding = "DRIVE_CACHE"
bucket_name = "orcabot-drive-cache"

# Cron triggers for background tasks
[triggers]
crons = ["* * * * *"]
