# DEVELOPMENT configuration for orcabot-controlplane
# For production, use: wrangler deploy -c wrangler.production.toml
#
# WARNING: This config has DEV_AUTH_ENABLED=true which allows anyone to
# spoof authentication via headers. NEVER deploy this to production.
#
# SETUP: Before running locally, set secrets:
#   wrangler secret put SANDBOX_INTERNAL_TOKEN
#   wrangler secret put INTERNAL_API_TOKEN
#
# Or for local dev with .dev.vars file, create controlplane/.dev.vars:
#   SANDBOX_URL=https://your-sandbox.fly.dev/
#   SANDBOX_INTERNAL_TOKEN=your-dev-token-here
#   INTERNAL_API_TOKEN=your-dev-token-here

name = "orcabot-controlplane"
main = "src/index.ts"
compatibility_date = "2024-01-01"

[vars]
# DEV ONLY - header-based auth bypass (DISABLE IN PRODUCTION)
DEV_AUTH_ENABLED = "true"
# Email sender address for invitation emails
EMAIL_FROM = "OrcaBot <noreply@orcabot.com>"

# SECRETS - Set via `wrangler secret put` or .dev.vars file (NOT here!)
# Required secrets:
#   SANDBOX_URL - URL of the sandbox server
#   SANDBOX_INTERNAL_TOKEN - Token for control plane -> sandbox auth
#   INTERNAL_API_TOKEN - Token for internal API calls
#   RESEND_API_KEY - API key for Resend email service (optional, for sharing invites)

# Rate limiting - unauthenticated (strict)
[[unsafe.bindings]]
name = "RATE_LIMITER"
type = "ratelimit"
namespace_id = "1"
simple = { limit = 10, period = 60 }  # 10 requests per minute per IP

# Rate limiting - authenticated (generous)
[[unsafe.bindings]]
name = "RATE_LIMITER_AUTH"
type = "ratelimit"
namespace_id = "2"
simple = { limit = 200, period = 60 }  # 200 requests per minute per user

# Durable Objects for real-time collaboration
[[durable_objects.bindings]]
name = "DASHBOARD"
class_name = "DashboardDO"

# Durable Objects for integration policy rate limiting
[[durable_objects.bindings]]
name = "RATE_LIMIT_COUNTER"
class_name = "RateLimitCounter"

[[migrations]]
tag = "v1"
new_sqlite_classes = ["DashboardDO"]

[[migrations]]
tag = "v2"
new_sqlite_classes = ["RateLimitCounter"]

# D1 Database for persistent state
[[d1_databases]]
binding = "DB"
database_name = "orcabot-db"
database_id = "7d6525ac-8867-4e8a-8f02-0ec3dfa288a2"

# Cron triggers for background tasks
[triggers]
crons = ["* * * * *"]  # Every minute: health checks + schedule processing

[[r2_buckets]]
binding = "DRIVE_CACHE"
bucket_name = "orcabot-drive-cache"

# For local development
[dev]
port = 8787
local_protocol = "http"
